#!/usr/bin/env node

const { Client } = require("pg");
const { argv } = require('node:process');

// get the command and arguments from user input
let command = argv[2];
let args = argv.slice(3);

// main command processing logic
if (command === undefined) {
  displayHelp();
} else if (command === 'list') {
  displayList();
} else if (command === 'clear') {
  clearExpenses();
} else if (command === 'add') {
  let [amount, memo, date] = args.slice(1, 4);
  addExpense(amount, memo, date);
} else if (command === 'delete') {
  deleteExpense(args[1])
}

// list command
function displayList() {
  const client = new Client({database: "expenses", password: "psql"});

  async function getData(queryText) {
    return client.query(queryText);
  }

  (async () => {
    await client.connect();
    const data = await getData('SELECT * FROM expenses ORDER BY created_on ASC');
    displayFormattedData(data);
    await client.end();
  })();

  function displayFormattedData(data) {
    data.rows.forEach(row => {
      let colums = [
        `${row.id}`.padStart(3),
        row.created_on.toDateString().padStart(10),
        Number(row.amount).toFixed(2).padStart(8),
        row.memo
      ];

      console.log(colums.join(` | `));
    })
  }  
}

// help command
function displayHelp() {
    let output = `An expense recording system

Commands:

add AMOUNT MEMO [DATE] - record a new expense
clear - delete all expenses
list - list all expenses
delete NUMBER - remove expense with id NUMBER
search QUERY - list expenses with a matching memo field`;
  
  console.log(output);
};